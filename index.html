<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Código Secreto Online</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400..900&family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --glow-color: #00aaff;
            --ok-color: #00ff87;
            --pica-color: #ffdd00;
            --error-color: #ff4d4d;
            --bg-dark: #0a0a14;
            --bg-light: #1a2035;
        }

        body {
            font-family: 'Roboto Mono', monospace;
            background-color: var(--bg-dark);
            background-image: radial-gradient(circle at center, var(--bg-light), var(--bg-dark) 80%);
            color: #e0e0e0;
            overflow: hidden;
        }
        
        .font-title { font-family: 'Orbitron', sans-serif; }

        .card {
            background-color: rgba(10, 25, 47, 0.85);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(0, 170, 255, 0.3);
            border-radius: 0.75rem;
            padding: 1.5rem;
            box-shadow: 0 0 15px rgba(0, 170, 255, 0.1), 0 0 30px rgba(0, 170, 255, 0.1);
            animation: fadeIn 0.5s ease-out forwards;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .input-field {
            background-color: rgba(0, 0, 0, 0.3);
            border: 1px solid #374151;
            color: #f9fafb;
            border-radius: 0.5rem;
            padding: 0.75rem 1rem;
            width: 100%;
            transition: border-color 0.3s, box-shadow 0.3s;
        }

        .input-field:focus {
            outline: none;
            border-color: var(--glow-color);
            box-shadow: 0 0 10px var(--glow-color);
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 700;
            color: white;
            transition: all 0.3s ease;
            cursor: pointer;
            border: 1px solid var(--glow-color);
            background: linear-gradient(45deg, #005f80, #00aaff);
            text-shadow: 0 0 5px rgba(255, 255, 255, 0.5);
            box-shadow: 0 0 8px var(--glow-color), inset 0 0 8px rgba(0, 170, 255, 0.5);
        }

        .btn:hover:not(:disabled) {
            transform: scale(1.05);
            box-shadow: 0 0 15px var(--glow-color), inset 0 0 15px rgba(0, 170, 255, 0.5);
        }
        
        .btn:disabled {
            background: #374151;
            border-color: #4b5563;
            cursor: not-allowed;
            box-shadow: none;
            color: #9ca3af; text-shadow: none;
        }

        .history-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 0.75rem 1rem; background-color: rgba(0, 0, 0, 0.2);
            border-radius: 0.5rem; margin-bottom: 0.5rem;
            border-left: 3px solid var(--glow-color);
            animation: slideIn 0.4s ease-out forwards;
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .pica { color: var(--pica-color); font-weight: bold; text-shadow: 0 0 5px var(--pica-color); }
        .ok { color: var(--ok-color); font-weight: bold; text-shadow: 0 0 5px var(--ok-color); }
        
        .turn-active {
            border-color: var(--glow-color);
            box-shadow: 0 0 25px rgba(0, 170, 255, 0.3);
            transform: scale(1.02);
        }
        
        #turn-indicator { transition: all 0.5s ease; }
        
        .hidden { display: none !important; }

        .toast {
            position: fixed; bottom: 20px; left: 50%;
            transform: translateX(-50%);
            background-color: #1f2937; color: white;
            padding: 10px 20px; border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
            z-index: 100;
            animation: toast-in 0.5s, toast-out 0.5s 2.5s;
            opacity: 0;
        }

        @keyframes toast-in { from { bottom: -50px; opacity: 0; } to { bottom: 20px; opacity: 1; } }
        @keyframes toast-out { from { bottom: 20px; opacity: 1; } to { bottom: -50px; opacity: 0; } }
        
        .exit-btn {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 50;
            background: linear-gradient(45deg, #800000, #ff4d4d);
            border-color: var(--error-color);
            box-shadow: 0 0 8px var(--error-color), inset 0 0 8px rgba(255, 77, 77, 0.5);
        }
        .exit-btn:hover {
            box-shadow: 0 0 15px var(--error-color), inset 0 0 15px rgba(255, 77, 77, 0.5);
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <button id="exit-game-btn" class="btn exit-btn hidden" data-lang="exitGame">Salir de Partida</button>

    <div id="game-container" class="w-full max-w-4xl mx-auto">
        <h1 class="font-title text-5xl font-bold text-center mb-2 text-white" style="text-shadow: 0 0 10px var(--glow-color);">Código Secreto</h1>
        <p id="turn-indicator" class="text-center text-xl text-cyan-300 mb-6 h-7 font-bold"></p>

        <!-- Language Selection -->
        <div id="language-section" class="card">
            <h2 class="font-title text-2xl font-semibold text-center mb-6 text-cyan-300">Select Language / Selecciona Idioma</h2>
            <div class="flex justify-center gap-4">
                <button id="lang-en-btn" class="btn text-lg">English</button>
                <button id="lang-es-btn" class="btn text-lg">Español</button>
            </div>
        </div>

        <!-- Main Menu Section -->
        <div id="main-menu-section" class="card hidden">
            <h2 class="font-title text-2xl font-semibold text-center mb-6 text-cyan-300" data-lang="gameModeTitle">Modo de Juego</h2>
            <div class="space-y-4">
                <button id="show-offline-menu-btn" class="btn text-lg w-full" data-lang="playOffline">Jugar Offline</button>
                <button id="show-online-menu-btn" class="btn text-lg w-full" data-lang="playOnline">Jugar Online</button>
                <div class="pt-4 border-t border-gray-700"></div>
                <button id="instructions-btn" class="btn text-lg w-full !bg-gray-600 hover:!bg-gray-700 !border-gray-500" data-lang="instructions">Instrucciones</button>
                <button id="back-to-lang-btn" class="px-3 py-1 text-xs rounded-full bg-purple-800 hover:bg-purple-700 border border-purple-600 transition-colors" data-lang="changeLanguage">Cambiar Idioma</button>
            </div>
        </div>

        <!-- Offline Lobby Section -->
        <div id="offline-lobby-section" class="card hidden">
            <h2 class="font-title text-2xl font-semibold text-center mb-6 text-cyan-300" data-lang="offlineMode">Modo Offline</h2>
            <div class="space-y-4">
                <button id="single-player-btn" class="btn text-lg w-full" data-lang="singlePlayer">Un Jugador</button>
                <button id="offline-game-btn" class="btn text-lg w-full" data-lang="offline2p">Dos Jugadores Offline</button>
                <div class="pt-4 border-t border-gray-700">
                    <button class="back-to-main-menu-btn btn text-lg w-full !bg-gray-600 hover:!bg-gray-700 !border-gray-500" data-lang="back">Volver</button>
                </div>
            </div>
        </div>

        <!-- Online Lobby Section -->
        <div id="online-lobby-section" class="card hidden">
            <h2 class="font-title text-2xl font-semibold text-center mb-6 text-cyan-300" data-lang="onlineMode">Modo Online</h2>
            <div class="space-y-4">
                <button id="create-race-btn" class="btn text-lg w-full" data-lang="createRace">Crear Carrera</button>
                <button id="create-game-btn" class="btn text-lg w-full" data-lang="createOnline">Crear Duelo 1v1</button>
                <div class="pt-4 border-t border-gray-700"></div>
                <div class="space-y-2">
                    <input type="text" id="join-game-id" class="input-field text-center" data-lang-placeholder="joinPlaceholder">
                    <button id="join-game-btn" class="btn text-lg w-full" data-lang="joinGame">Unirse a Juego</button>
                    <p id="lobby-error" class="text-sm h-5 text-center" style="color: var(--error-color);"></p>
                </div>
                <div class="pt-4 border-t border-gray-700">
                    <button class="back-to-main-menu-btn btn text-lg w-full !bg-gray-600 hover:!bg-gray-700 !border-gray-500" data-lang="back">Volver</button>
                </div>
            </div>
        </div>

        <!-- Single Player Setup Section -->
        <div id="single-player-setup-section" class="card hidden">
            <h2 class="font-title text-2xl font-semibold text-center mb-6 text-cyan-300" data-lang="singlePlayerTitle">Modo Un Jugador</h2>
            <p class="text-center mb-6" data-lang="timeLimitPrompt">Selecciona el límite de tiempo para adivinar el código.</p>
            <div class="flex flex-wrap justify-center gap-4">
                <button class="btn text-lg" onclick="startSinglePlayerGame(180)" data-lang="timeNormal">3 Minutos (Normal)</button>
                <button class="btn text-lg" onclick="startSinglePlayerGame(300)" data-lang="timeEasy">5 Minutos (Fácil)</button>
                <button class="btn text-lg" onclick="startSinglePlayerGame(600)" data-lang="timeVeryEasy">10 Minutos (Muy Fácil)</button>
            </div>
        </div>
        
        <!-- Offline Setup Section -->
        <div id="offline-setup-section" class="card hidden">
            <h2 class="font-title text-2xl font-semibold text-center mb-6 text-cyan-300" data-lang="offlineSetupTitle">Configuración Offline</h2>
            <div class="grid md:grid-cols-2 gap-8">
                <div class="space-y-4">
                    <label for="p1-offline-name" class="block font-medium text-lg" data-lang="p1Name">Nombre Jugador 1</label>
                    <input type="text" id="p1-offline-name" class="input-field" data-lang-placeholder="p1Placeholder">
                    <label for="p1-offline-code" class="block font-medium text-lg mt-4" data-lang="secretCode">Código Secreto</label>
                    <input type="password" id="p1-offline-code" class="input-field font-mono" data-lang-placeholder="codeInputPlaceholder" maxlength="4">
                    <p id="p1-offline-error" class="text-red-500 text-sm h-5"></p>
                </div>
                <div class="space-y-4">
                    <label for="p2-offline-name" class="block font-medium text-lg" data-lang="p2Name">Nombre Jugador 2</label>
                    <input type="text" id="p2-offline-name" class="input-field" data-lang-placeholder="p2Placeholder">
                    <label for="p2-offline-code" class="block font-medium text-lg mt-4" data-lang="secretCode">Código Secreto</label>
                    <input type="password" id="p2-offline-code" class="input-field font-mono" data-lang-placeholder="codeInputPlaceholder" maxlength="4">
                    <p id="p2-offline-error" class="text-red-500 text-sm h-5"></p>
                </div>
            </div>
            <div class="mt-8 flex justify-center">
                <button id="start-offline-game-btn" class="btn text-lg" data-lang="startGame">Comenzar a Jugar</button>
            </div>
        </div>

        <!-- Online Waiting Section -->
        <div id="waiting-section" class="card text-center hidden">
            <h2 id="waiting-title" class="font-title text-2xl font-semibold mb-4 text-cyan-300" data-lang="waitingTitle">Esperando Oponente</h2>
            <p class="mb-4" data-lang="shareId">Comparte este ID con tus amigos:</p>
            <div class="flex items-center justify-center bg-gray-900 p-3 rounded-lg gap-4">
                <p id="game-id-display" class="text-2xl font-bold text-yellow-300"></p>
                <button id="copy-id-btn" class="btn !p-2 !text-sm" data-lang="copy">Copiar</button>
            </div>
            <div id="race-lobby-players" class="mt-4"></div>
            <button id="start-race-btn" class="btn text-lg mt-4 hidden" data-lang="startGameRace">Comenzar Carrera</button>
        </div>

        <!-- Online Setup Section -->
        <div id="setup-section" class="card hidden">
            <h2 class="font-title text-2xl font-semibold text-center mb-6 text-cyan-300" data-lang="onlineSetupTitle">Configura tu Jugador</h2>
            <div class="max-w-xs mx-auto space-y-4">
                <div>
                    <label for="online-name-input" class="block font-medium text-lg mb-2" data-lang="yourName">Tu Nombre</label>
                    <input type="text" id="online-name-input" class="input-field text-center" data-lang-placeholder="anonymousPlaceholder">
                </div>
                <div id="secret-code-container">
                    <label for="secret-code-input" class="block font-medium text-lg mb-2" data-lang="yourCode">Tu Código Secreto</label>
                    <input type="password" id="secret-code-input" class="input-field text-center" data-lang-placeholder="codeInputPlaceholder" maxlength="4">
                </div>
                <button id="submit-code-btn" class="btn text-lg w-full" data-lang="confirm">Confirmar</button>
                <p id="setup-error" class="text-sm h-5 text-center" style="color: var(--error-color);"></p>
                <p id="setup-status" class="text-sm h-5 text-center text-yellow-300"></p>
            </div>
        </div>

        <!-- Game Section -->
        <div id="game-section" class="hidden">
             <div class="grid md:grid-cols-2 gap-6" id="game-boards-container">
                <!-- Boards will be rendered here -->
             </div>
        </div>
    </div>

    <!-- Winner Modal -->
    <div id="winner-modal" class="hidden fixed inset-0 bg-black bg-opacity-80 backdrop-filter backdrop-blur-sm flex items-center justify-center z-50">
        <div class="card text-center space-y-6 border-2" style="border-color: var(--ok-color); box-shadow: 0 0 20px var(--ok-color);">
            <h2 id="winner-message" class="font-title text-3xl font-bold" style="color: var(--ok-color); text-shadow: 0 0 8px var(--ok-color);"></h2>
            <p id="winner-details" class="text-lg"></p>
            <button id="play-again-btn" class="btn text-lg" data-lang="backToMenu">Volver al Menú</button>
        </div>
    </div>

    <!-- Opponent Left Modal -->
    <div id="opponent-left-modal" class="hidden fixed inset-0 bg-black bg-opacity-80 backdrop-filter backdrop-blur-sm flex items-center justify-center z-50">
        <div class="card text-center space-y-6 border-2" style="border-color: var(--pica-color); box-shadow: 0 0 20px var(--pica-color);">
            <h2 class="font-title text-3xl font-bold" style="color: var(--pica-color); text-shadow: 0 0 8px var(--pica-color);" data-lang="opponentLeft">Tu oponente ha abandonado la partida.</h2>
            <button id="opponent-left-ok-btn" class="btn text-lg" data-lang="backToMenu">Volver al Menú</button>
        </div>
    </div>

    <!-- Instructions Modal -->
    <div id="instructions-modal" class="hidden fixed inset-0 bg-black bg-opacity-80 backdrop-filter backdrop-blur-sm flex items-center justify-center z-50 p-4">
        <div class="card text-left space-y-4 max-w-lg w-full max-h-full overflow-y-auto">
            <h2 class="font-title text-2xl font-semibold text-center text-cyan-300" data-lang="instructionsTitle">Instrucciones del Juego</h2>
            <div>
                <h3 class="font-bold text-lg text-cyan-400 mb-2" data-lang="objectiveTitle">Objetivo:</h3>
                <p data-lang="objectiveText">Adivinar el código secreto de 4 dígitos de tu oponente (o de la computadora) antes de que se acabe el tiempo o te ganen.</p>
            </div>
            <div>
                <h3 class="font-bold text-lg text-cyan-400 mb-2" data-lang="cluesTitle">Pistas:</h3>
                <ul class="list-disc list-inside space-y-1">
                    <li data-lang="clueOK"><span class="ok">OK:</span> Significa que un dígito es correcto y está en la posición correcta.</li>
                    <li data-lang="cluePica"><span class="pica">Pica:</span> Significa que un dígito es correcto, pero está en la posición incorrecta.</li>
                </ul>
            </div>
             <div>
                <h3 class="font-bold text-lg text-cyan-400 mb-2" data-lang="modesTitle">Modos de Juego:</h3>
                <ul class="list-disc list-inside space-y-1">
                    <li data-lang="modeSingle"><strong>Un Jugador:</strong> Juegas contra la computadora con un límite de tiempo.</li>
                    <li data-lang="modeOffline"><strong>Dos Jugadores Offline:</strong> Dos jugadores en el mismo dispositivo.</li>
                    <li data-lang="modeOnline"><strong>Online:</strong> Un jugador crea una partida, comparte el ID, y el otro se une.</li>
                </ul>
            </div>
            <div class="mt-6 flex justify-center">
                <button id="close-instructions-btn" class="btn text-lg" data-lang="gotIt">Entendido</button>
            </div>
        </div>
    </div>
    
    <div id="toast-container"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, updateDoc, collection, deleteField } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Config ---
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'codigo-secreto-default';

        // --- App Initialization ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- DOM Elements ---
        const winnerModal = document.getElementById('winner-modal');
        const opponentLeftModal = document.getElementById('opponent-left-modal');
        const turnIndicator = document.getElementById('turn-indicator');
        const instructionsModal = document.getElementById('instructions-modal');
        const exitGameBtn = document.getElementById('exit-game-btn');
        
        // --- Game State ---
        let userId = null;
        let gameId = null;
        let gameUnsubscribe = null;
        let offlineState = {};
        let singlePlayerState = {};
        let mySecretCode = null;
        let currentLanguage = 'es';
        let currentOnlineGameType = null;

        // --- TRANSLATIONS ---
        const translations = {
            es: {
                // Lobby
                gameModeTitle: "Modo de Juego",
                playOffline: "Jugar Offline",
                playOnline: "Jugar Online",
                offlineMode: "Modo Offline",
                onlineMode: "Modo Online",
                back: "Volver",
                instructions: "Instrucciones",
                singlePlayer: "Un Jugador",
                offline2p: "Dos Jugadores Offline",
                createOnline: "Crear Duelo 1v1",
                createRace: "Crear Carrera",
                joinGame: "Unirse a Juego",
                joinPlaceholder: "Pega el ID del Juego aquí",
                changeLanguage: "Cambiar Idioma",
                // Single Player Setup
                singlePlayerTitle: "Modo Un Jugador",
                timeLimitPrompt: "Selecciona el límite de tiempo para adivinar el código.",
                timeVeryEasy: "10 Minutos (Muy Fácil)",
                timeEasy: "5 Minutos (Fácil)",
                timeNormal: "3 Minutos (Normal)",
                // Offline Setup
                offlineSetupTitle: "Configuración Offline",
                p1Name: "Nombre Jugador 1",
                p2Name: "Nombre Jugador 2",
                p1Placeholder: "Jugador 1",
                p2Placeholder: "Jugador 2",
                secretCode: "Código Secreto",
                codeInputPlaceholder: "4 dígitos únicos",
                startGame: "Comenzar a Jugar",
                startGameRace: "Comenzar Carrera",
                // Online
                waitingTitle: "Esperando Oponente",
                waitingRaceTitle: "Lobby de Carrera",
                playersInLobby: "Jugadores en el lobby:",
                shareId: "Comparte este ID con tus amigos:",
                copy: "Copiar",
                onlineSetupTitle: "Configura tu Jugador",
                yourName: "Tu Nombre",
                anonymousPlaceholder: "Jugador Anónimo",
                yourCode: "Tu Código Secreto",
                confirm: "Confirmar",
                // In-Game
                exitGame: "Salir de Partida",
                turnIndicator: ">>> TURNO DE {playerName} <<<",
                timerIndicator: "Tiempo Restante: {time}",
                guessInputPlaceholder: "Tu intento...",
                guessButton: "Adivinar",
                yourCodeIs: "Tu código: {code}",
                opponentIsGuessing: "Adivinando tu código...",
                guessOpponentCode: "Adivina el código de {opponentName}",
                raceGuessPrompt: "¡Adivina el código de la computadora!",
                // Modals
                backToMenu: "Volver al Menú",
                instructionsTitle: "Instrucciones del Juego",
                objectiveTitle: "Objetivo:",
                objectiveText: "Adivinar el código secreto de 4 dígitos de tu oponente (o de la computadora) antes de que se acabe el tiempo o te ganen.",
                cluesTitle: "Pistas:",
                clueOK: "OK: Significa que un dígito es correcto y está en la posición correcta.",
                cluePica: "Pica: Significa que un dígito es correcto, pero está en la posición incorrecta.",
                modesTitle: "Modos de Juego:",
                modeSingle: "Un Jugador: Juegas contra la computadora con un límite de tiempo.",
                modeOffline: "Dos Jugadores Offline: Dos jugadores en el mismo dispositivo.",
                modeOnline: "Online: Un jugador crea una partida, comparte el ID, y el otro se une.",
                gotIt: "Entendido",
                opponentLeft: "Tu oponente ha abandonado la partida.",
                // Messages
                winnerMessage: "¡{winnerName} HA GANADO!",
                timeUpMessage: "¡Se acabó el tiempo!",
                codeWas: "El código era: {code}",
                youWon: "¡HAS GANADO!",
                invalidCode: "El código debe tener 4 dígitos únicos.",
                invalidGuess: "Intento inválido. 4 dígitos únicos.",
                gameNotFound: "Juego no encontrado o ya iniciado.",
                idCopied: "ID copiado al portapapeles",
                copyFailed: "No se pudo copiar el ID",
                waitingForOpponent: "Esperando al oponente..."
            },
            en: {
                // Lobby
                gameModeTitle: "Game Mode",
                playOffline: "Play Offline",
                playOnline: "Play Online",
                offlineMode: "Offline Mode",
                onlineMode: "Online Mode",
                back: "Back",
                instructions: "Instructions",
                singlePlayer: "Single Player",
                offline2p: "Two Players Offline",
                createOnline: "Create 1v1 Duel",
                createRace: "Create Race",
                joinGame: "Join Game",
                joinPlaceholder: "Paste Game ID here",
                changeLanguage: "Change Language",
                // Single Player Setup
                singlePlayerTitle: "Single Player Mode",
                timeLimitPrompt: "Select the time limit to guess the code.",
                timeVeryEasy: "10 Minutes (Very Easy)",
                timeEasy: "5 Minutes (Easy)",
                timeNormal: "3 Minutes (Normal)",
                // Offline Setup
                offlineSetupTitle: "Offline Setup",
                p1Name: "Player 1 Name",
                p2Name: "Player 2 Name",
                p1Placeholder: "Player 1",
                p2Placeholder: "Player 2",
                secretCode: "Secret Code",
                codeInputPlaceholder: "4 unique digits",
                startGame: "Start Game",
                startGameRace: "Start Race",
                // Online
                waitingTitle: "Waiting for Opponent",
                waitingRaceTitle: "Race Lobby",
                playersInLobby: "Players in lobby:",
                shareId: "Share this ID with your friends:",
                copy: "Copy",
                onlineSetupTitle: "Setup Your Player",
                yourName: "Your Name",
                anonymousPlaceholder: "Anonymous Player",
                yourCode: "Your Secret Code",
                confirm: "Confirm",
                // In-Game
                exitGame: "Exit Game",
                turnIndicator: ">>> {playerName}'S TURN <<<",
                timerIndicator: "Time Left: {time}",
                guessInputPlaceholder: "Your guess...",
                guessButton: "Guess",
                yourCodeIs: "Your code: {code}",
                opponentIsGuessing: "Guessing your code...",
                guessOpponentCode: "Guess {opponentName}'s code",
                raceGuessPrompt: "Guess the computer's code!",
                // Modals
                backToMenu: "Back to Menu",
                instructionsTitle: "Game Instructions",
                objectiveTitle: "Objective:",
                objectiveText: "Guess your opponent's (or the computer's) 4-digit secret code before time runs out or they guess yours.",
                cluesTitle: "Clues:",
                clueOK: "OK: Means a digit is correct and in the correct position.",
                cluePica: "Pica: Means a digit is correct but in the wrong position.",
                modesTitle: "Game Modes:",
                modeSingle: "Single Player: Play against the computer with a time limit.",
                modeOffline: "Two Players Offline: Two players on the same device.",
                modeOnline: "Online: One player creates a game, shares the ID, and the other joins.",
                gotIt: "Got It",
                opponentLeft: "Your opponent has left the game.",
                // Messages
                winnerMessage: "{winnerName} WINS!",
                timeUpMessage: "Time's Up!",
                codeWas: "The code was: {code}",
                youWon: "YOU WON!",
                invalidCode: "Code must be 4 unique digits.",
                invalidGuess: "Invalid guess. 4 unique digits.",
                gameNotFound: "Game not found or already started.",
                idCopied: "ID copied to clipboard",
                copyFailed: "Could not copy ID",
                waitingForOpponent: "Waiting for opponent..."
            }
        };

        function setLanguage(lang) {
            currentLanguage = lang;
            document.querySelectorAll('[data-lang]').forEach(el => {
                const key = el.dataset.lang;
                if (translations[lang][key]) {
                    el.textContent = translations[lang][key];
                }
            });
            document.querySelectorAll('[data-lang-placeholder]').forEach(el => {
                const key = el.dataset.langPlaceholder;
                if (translations[lang][key]) {
                    el.placeholder = translations[lang][key];
                }
            });
        }

        // --- UI Functions ---
        function showSection(section) {
            ['language-section', 'main-menu-section', 'offline-lobby-section', 'online-lobby-section', 'single-player-setup-section', 'offline-setup-section', 'waiting-section', 'setup-section', 'game-section'].forEach(id => {
                document.getElementById(id).classList.add('hidden');
            });
            if (section) document.getElementById(section).classList.remove('hidden');
        }
        
        function showToast(messageKey) {
            const message = translations[currentLanguage][messageKey];
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = message;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }
        
        // --- Game Logic (Shared) ---
        function isValidCode(code) {
            return /^\d{4}$/.test(code) && new Set(code.split('')).size === 4;
        }
        
        function checkGuess(guess, secretCode) {
            let oks = 0, picas = 0;
            const secretDigits = secretCode.split(''), guessDigits = guess.split('');
            const secretChecked = [!1,!1,!1,!1], guessChecked = [!1,!1,!1,!1];
            for(let i=0;i<4;i++) guessDigits[i]===secretDigits[i]&&(oks++,secretChecked[i]=!0,guessChecked[i]=!0);
            for(let i=0;i<4;i++){if(guessChecked[i])continue;for(let j=0;j<4;j++){if(secretChecked[j])continue;if(guessDigits[i]===secretDigits[j]){picas++,secretChecked[j]=!0;break}}}
            return {picas, oks};
        }

        function showWinner(winnerName, details = "") {
            document.getElementById('winner-message').textContent = translations[currentLanguage].winnerMessage.replace('{winnerName}', winnerName);
            document.getElementById('winner-details').textContent = details;
            winnerModal.classList.remove('hidden');
            exitGameBtn.classList.add('hidden');
        }
        
        function showLoser(messageKey, details = "") {
            document.getElementById('winner-message').textContent = translations[currentLanguage][messageKey];
            document.getElementById('winner-message').style.color = 'var(--error-color)';
            document.getElementById('winner-details').textContent = details;
            winnerModal.classList.remove('hidden');
            exitGameBtn.classList.add('hidden');
        }
        
        function generateComputerCode() {
            const digits = ['0', '1', '2', '3', '4', '5', '6', '7', '8', '9'];
            for (let i = digits.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [digits[i], digits[j]] = [digits[j], digits[i]];
            }
            return digits.slice(0, 4).join('');
        }

        // --- SINGLE PLAYER MODE ---
        window.startSinglePlayerGame = function(timeLimit) {
            singlePlayerState = {
                secretCode: generateComputerCode(),
                timeLeft: timeLimit,
                history: [],
                timerId: null
            };
            
            renderSinglePlayerBoard();
            showSection('game-section');
            exitGameBtn.classList.remove('hidden');
            
            singlePlayerState.timerId = setInterval(() => {
                singlePlayerState.timeLeft--;
                const minutes = Math.floor(singlePlayerState.timeLeft / 60).toString().padStart(2, '0');
                const seconds = (singlePlayerState.timeLeft % 60).toString().padStart(2, '0');
                turnIndicator.textContent = translations[currentLanguage].timerIndicator.replace('{time}', `${minutes}:${seconds}`);

                if (singlePlayerState.timeLeft <= 0) {
                    clearInterval(singlePlayerState.timerId);
                    const details = translations[currentLanguage].codeWas.replace('{code}', singlePlayerState.secretCode);
                    showLoser("timeUpMessage", details);
                }
            }, 1000);
        }

        function renderSinglePlayerBoard() {
            const container = document.getElementById('game-boards-container');
            container.innerHTML = `
                <div class="md:col-span-2 max-w-md mx-auto w-full">
                    <div id="single-player-board" class="card space-y-4"></div>
                </div>
            `;
            updateSinglePlayerUI();
        }

        function updateSinglePlayerUI() {
            const historyHtml = singlePlayerState.history.map(h => `<div class="history-item"><span>${h.guess}</span><div class="flex gap-4"><span class="pica">${h.picas} Pica</span><span class="ok">${h.oks} OK</span></div></div>`).join('');
            document.getElementById('single-player-board').innerHTML = `
                <h3 class="font-title text-xl font-semibold text-center text-cyan-300" data-lang="guessTheCode">Adivina el Código</h3>
                <div class="flex gap-2">
                    <input type="text" id="single-player-guess" class="input-field" placeholder="${translations[currentLanguage].guessInputPlaceholder}" maxlength="4">
                    <button id="single-player-guess-btn" class="btn">${translations[currentLanguage].guessButton}</button>
                </div>
                <p id="single-player-guess-error" class="text-sm h-5" style="color: var(--error-color);"></p>
                <div class="h-80 overflow-y-auto pr-2">${historyHtml}</div>
            `;
            document.getElementById('single-player-guess-btn').addEventListener('click', handleSinglePlayerGuess);
            document.getElementById('single-player-guess').addEventListener('keyup', e => { if (e.key === 'Enter') document.getElementById('single-player-guess-btn').click(); });
        }

        function handleSinglePlayerGuess() {
            const guessInput = document.getElementById('single-player-guess');
            const errorEl = document.getElementById('single-player-guess-error');
            const guess = guessInput.value;
            errorEl.textContent = '';

            if (!isValidCode(guess)) {
                errorEl.textContent = translations[currentLanguage].invalidGuess;
                return;
            }

            const { picas, oks } = checkGuess(guess, singlePlayerState.secretCode);
            singlePlayerState.history.unshift({ guess, picas, oks });

            if (oks === 4) {
                clearInterval(singlePlayerState.timerId);
                showWinner(translations[currentLanguage].youWon);
                return;
            }
            
            guessInput.value = '';
            updateSinglePlayerUI();
        }


        // --- OFFLINE MODE ---
        function startOfflineSetup() {
            showSection('offline-setup-section');
            exitGameBtn.classList.remove('hidden');
        }

        function startOfflineGame() {
            const p1NameInput = document.getElementById('p1-offline-name');
            const p2NameInput = document.getElementById('p2-offline-name');
            const p1CodeInput = document.getElementById('p1-offline-code');
            const p2CodeInput = document.getElementById('p2-offline-code');
            const p1Error = document.getElementById('p1-offline-error');
            const p2Error = document.getElementById('p2-offline-error');
            
            p1Error.textContent = '';
            p2Error.textContent = '';
            let valid = true;

            if (!isValidCode(p1CodeInput.value)) {
                p1Error.textContent = translations[currentLanguage].invalidCode;
                valid = false;
            }
            if (!isValidCode(p2CodeInput.value)) {
                p2Error.textContent = translations[currentLanguage].invalidCode;
                valid = false;
            }

            if (valid) {
                offlineState = {
                    p1Name: p1NameInput.value || translations[currentLanguage].p1Placeholder,
                    p2Name: p2NameInput.value || translations[currentLanguage].p2Placeholder,
                    p1Code: p1CodeInput.value,
                    p2Code: p2CodeInput.value,
                    currentPlayer: 1,
                    p1History: [],
                    p2History: [],
                };
                renderOfflineGameBoard();
                showSection('game-section');
            }
        }

        function renderOfflineGameBoard() {
            const container = document.getElementById('game-boards-container');
            container.innerHTML = `
                <div id="offline-p1-board" class="card space-y-4 transition-all duration-500"></div>
                <div id="offline-p2-board" class="card space-y-4 transition-all duration-500"></div>
            `;
            updateOfflineTurnUI();
        }
        
        function updateOfflineTurnUI() {
            const { currentPlayer, p1History, p2History, p1Name, p2Name } = offlineState;
            const isP1Turn = currentPlayer === 1;

            const p1HistoryHtml = p1History.map(h => `<div class="history-item"><span>${h.guess}</span><div class="flex gap-4"><span class="pica">${h.picas} Pica</span><span class="ok">${h.oks} OK</span></div></div>`).join('');
            const p2HistoryHtml = p2History.map(h => `<div class="history-item"><span>${h.guess}</span><div class="flex gap-4"><span class="pica">${h.picas} Pica</span><span class="ok">${h.oks} OK</span></div></div>`).join('');

            document.getElementById('offline-p1-board').innerHTML = `
                <h3 class="font-title text-xl font-semibold text-center text-cyan-300">${p1Name}</h3>
                <div class="flex gap-2">
                    <input type="text" id="offline-p1-guess" class="input-field" placeholder="${translations[currentLanguage].guessInputPlaceholder}" maxlength="4" ${!isP1Turn ? 'disabled' : ''}>
                    <button id="offline-p1-guess-btn" class="btn" ${!isP1Turn ? 'disabled' : ''}>${translations[currentLanguage].guessButton}</button>
                </div>
                <p id="offline-p1-guess-error" class="text-sm h-5" style="color: var(--error-color);"></p>
                <div class="h-80 overflow-y-auto pr-2">${p1HistoryHtml}</div>
            `;
            document.getElementById('offline-p2-board').innerHTML = `
                <h3 class="font-title text-xl font-semibold text-center text-cyan-300">${p2Name}</h3>
                <div class="flex gap-2">
                    <input type="text" id="offline-p2-guess" class="input-field" placeholder="${translations[currentLanguage].guessInputPlaceholder}" maxlength="4" ${isP1Turn ? 'disabled' : ''}>
                    <button id="offline-p2-guess-btn" class="btn" ${isP1Turn ? 'disabled' : ''}>${translations[currentLanguage].guessButton}</button>
                </div>
                <p id="offline-p2-guess-error" class="text-sm h-5" style="color: var(--error-color);"></p>
                <div class="h-80 overflow-y-auto pr-2">${p2HistoryHtml}</div>
            `;
            
            document.getElementById('offline-p1-guess-btn').addEventListener('click', () => handleOfflineGuess(1));
            document.getElementById('offline-p2-guess-btn').addEventListener('click', () => handleOfflineGuess(2));
            document.getElementById('offline-p1-guess').addEventListener('keyup', e => { if (e.key === 'Enter') document.getElementById('offline-p1-guess-btn').click(); });
            document.getElementById('offline-p2-guess').addEventListener('keyup', e => { if (e.key === 'Enter') document.getElementById('offline-p2-guess-btn').click(); });

            turnIndicator.textContent = translations[currentLanguage].turnIndicator.replace('{playerName}', currentPlayer === 1 ? p1Name : p2Name);
            document.getElementById('offline-p1-board').classList.toggle('turn-active', isP1Turn);
            document.getElementById('offline-p1-board').classList.toggle('opacity-60', !isP1Turn);
            document.getElementById('offline-p2-board').classList.toggle('turn-active', !isP1Turn);
            document.getElementById('offline-p2-board').classList.toggle('opacity-60', isP1Turn);
        }

        function handleOfflineGuess(playerNum) {
            const guessInput = document.getElementById(`offline-p${playerNum}-guess`);
            const errorEl = document.getElementById(`offline-p${playerNum}-guess-error`);
            const guess = guessInput.value;
            errorEl.textContent = '';

            if (!isValidCode(guess)) {
                errorEl.textContent = translations[currentLanguage].invalidGuess;
                return;
            }

            const secretCode = playerNum === 1 ? offlineState.p2Code : offlineState.p1Code;
            const { picas, oks } = checkGuess(guess, secretCode);
            
            offlineState[`p${playerNum}History`].unshift({ guess, picas, oks });

            if (oks === 4) {
                showWinner(playerNum === 1 ? offlineState.p1Name : offlineState.p2Name);
                return;
            }
            
            offlineState.currentPlayer = playerNum === 1 ? 2 : 1;
            updateOfflineTurnUI();
        }

        // --- ONLINE MODE ---
        function renderOnlineGameBoard(gameData) {
            const playerNumber = gameData.player1Id === userId ? 1 : 2;
            const opponentNumber = playerNumber === 1 ? 2 : 1;
            const isMyTurn = gameData.currentPlayer === playerNumber;
            const myName = gameData[`player${playerNumber}Name`];
            const opponentName = gameData[`player${opponentNumber}Name`];

            const container = document.getElementById('game-boards-container');
            container.innerHTML = `
                <div id="online-p${playerNumber}-board" class="card space-y-4 transition-all duration-500"></div>
                <div id="online-p${opponentNumber}-board" class="card space-y-4 transition-all duration-500"></div>
            `;
            
            const myHistoryHtml = gameData[`player${playerNumber}History`].map(h => `<div class="history-item"><span>${h.guess}</span><div class="flex gap-4"><span class="pica">${h.picas} Pica</span><span class="ok">${h.oks} OK</span></div></div>`).join('');
            document.getElementById(`online-p${playerNumber}-board`).innerHTML = `
                <h3 class="font-title text-xl font-semibold text-center text-cyan-300">${myName} (Tú)</h3>
                <p class="text-center text-gray-400">${translations[currentLanguage].guessOpponentCode.replace('{opponentName}', opponentName)}</p>
                <p class="text-center text-xs text-gray-500 -mt-3 mb-2">${translations[currentLanguage].yourCodeIs.replace('{code}', mySecretCode)}</p>
                <div class="flex gap-2">
                    <input type="text" id="guess-input" class="input-field" placeholder="${translations[currentLanguage].guessInputPlaceholder}" maxlength="4" ${!isMyTurn ? 'disabled' : ''}>
                    <button id="guess-btn" class="btn" ${!isMyTurn ? 'disabled' : ''}>${translations[currentLanguage].guessButton}</button>
                </div>
                <p id="guess-error" class="text-sm h-5 text-center" style="color: var(--error-color);"></p>
                <div class="h-80 overflow-y-auto pr-2">${myHistoryHtml}</div>
            `;

            const opponentHistoryHtml = gameData[`player${opponentNumber}History`].map(h => `<div class="history-item"><span>${h.guess}</span><div class="flex gap-4"><span class="pica">${h.picas} Pica</span><span class="ok">${h.oks} OK</span></div></div>`).join('');
            document.getElementById(`online-p${opponentNumber}-board`).innerHTML = `
                <h3 class="font-title text-xl font-semibold text-center text-cyan-300">${opponentName}</h3>
                 <p class="text-center text-gray-400">${translations[currentLanguage].opponentIsGuessing}</p>
                 <div class="h-80 overflow-y-auto pr-2 mt-16">${opponentHistoryHtml}</div>
            `;
            
            document.getElementById('guess-btn').addEventListener('click', handleOnlineGuess);
            document.getElementById('guess-input').addEventListener('keyup', e => { if (e.key === 'Enter') document.getElementById('guess-btn').click(); });

            turnIndicator.textContent = translations[currentLanguage].turnIndicator.replace('{playerName}', gameData.currentPlayer === playerNumber ? myName : opponentName);
            document.getElementById(`online-p${playerNumber}-board`).classList.toggle('turn-active', isMyTurn);
            document.getElementById(`online-p${playerNumber}-board`).classList.toggle('opacity-60', !isMyTurn);
            document.getElementById(`online-p${opponentNumber}-board`).classList.toggle('turn-active', !isMyTurn);
            document.getElementById(`online-p${opponentNumber}-board`).classList.toggle('opacity-60', isMyTurn);
        }

        function renderOnline(gameData) {
            if (!gameData) {
                resetToLobby();
                return;
            }

            const playerNumber = gameData.player1Id === userId ? 1 : 2;
            const opponentNumber = playerNumber === 1 ? 2 : 1;
            exitGameBtn.classList.remove('hidden');

            switch (gameData.gameState) {
                case 'waiting':
                    document.getElementById('game-id-display').textContent = gameData.gameId;
                    showSection('waiting-section');
                    break;
                case 'setup':
                    showSection('setup-section');
                    const myCode = gameData[`player${playerNumber}Code`];
                    if (myCode) {
                        document.getElementById('online-name-input').disabled = true;
                        document.getElementById('secret-code-input').disabled = true;
                        document.getElementById('submit-code-btn').disabled = true;
                        document.getElementById('setup-status').textContent = translations[currentLanguage].waitingForOpponent;
                    } else {
                        document.getElementById('online-name-input').disabled = false;
                        document.getElementById('secret-code-input').disabled = false;
                        document.getElementById('submit-code-btn').disabled = false;
                        document.getElementById('setup-status').textContent = '';
                    }
                    break;
                case 'p1turn':
                case 'p2turn':
                    showSection('game-section');
                    renderOnlineGameBoard(gameData);
                    break;
                case 'p1won':
                case 'p2won':
                    showSection('game-section');
                    renderOnlineGameBoard(gameData);
                    const winnerNum = gameData.gameState === 'p1won' ? 1 : 2;
                    const winnerName = gameData[`player${winnerNum}Name`];
                    showWinner(winnerName);
                    break;
                case `p${opponentNumber}left`:
                    showSection('game-section');
                    opponentLeftModal.classList.remove('hidden');
                    if (gameUnsubscribe) gameUnsubscribe();
                    break;
                case `p${playerNumber}left`:
                    resetToLobby();
                    break;
            }
        }
        
        async function createOnlineGame() {
            gameId = doc(collection(db, `artifacts/${appId}/public/data/games`)).id.substring(0, 6).toUpperCase();
            const gameRef = doc(db, `artifacts/${appId}/public/data/games`, gameId);
            const newGame = {
                gameId: gameId, player1Id: userId, player2Id: null,
                player1Name: "Player 1", player2Name: "Player 2",
                gameState: 'waiting', player1Code: null, player2Code: null,
                currentPlayer: 1, player1History: [], player2History: [],
                createdAt: new Date(),
            };
            await setDoc(gameRef, newGame);
            listenToGame(gameId);
        }

        async function joinOnlineGame() {
            const joinId = document.getElementById('join-game-id').value.toUpperCase();
            if (!joinId) return;
            
            const gameRef = doc(db, `artifacts/${appId}/public/data/games`, joinId);
            const gameSnap = await getDoc(gameRef);

            if (gameSnap.exists() && gameSnap.data().gameState === 'waiting') {
                await updateDoc(gameRef, { player2Id: userId, gameState: 'setup' });
                gameId = joinId;
                listenToGame(gameId);
            } else {
                document.getElementById('lobby-error').textContent = translations[currentLanguage].gameNotFound;
            }
        }
        
        async function submitOnlineCode() {
            const name = document.getElementById('online-name-input').value;
            const code = document.getElementById('secret-code-input').value;
            const errorEl = document.getElementById('setup-error');
            errorEl.textContent = '';
            
            if (!isValidCode(code)) {
                errorEl.textContent = translations[currentLanguage].invalidCode;
                return;
            }
            
            mySecretCode = code; // Store code locally for display

            const gameRef = doc(db, `artifacts/${appId}/public/data/games`, gameId);
            const gameSnap = await getDoc(gameRef);
            const gameData = gameSnap.data();
            const playerNumber = gameData.player1Id === userId ? 1 : 2;
            
            const updatePayload = {};
            updatePayload[`player${playerNumber}Name`] = name || `${translations[currentLanguage].p1Placeholder.split(' ')[0]} ${playerNumber}`;
            updatePayload[`player${playerNumber}Code`] = code;
            
            const opponentNumber = playerNumber === 1 ? 2 : 1;
            if (gameData[`player${opponentNumber}Code`]) {
                updatePayload.gameState = 'p1turn';
            }
            
            await updateDoc(gameRef, updatePayload);
        }
        
        async function handleOnlineGuess() {
            const guess = document.getElementById('guess-input').value;
            const errorEl = document.getElementById('guess-error');
            errorEl.textContent = '';

            if (!isValidCode(guess)) {
                errorEl.textContent = translations[currentLanguage].invalidGuess;
                return;
            }

            const gameRef = doc(db, `artifacts/${appId}/public/data/games`, gameId);
            const gameSnap = await getDoc(gameRef);
            const gameData = gameSnap.data();

            const playerNumber = gameData.currentPlayer;
            const opponentNumber = playerNumber === 1 ? 2 : 1;
            const secretCode = gameData[`player${opponentNumber}Code`];

            const { picas, oks } = checkGuess(guess, secretCode);
            
            const newHistory = [...gameData[`player${playerNumber}History`], { guess, picas, oks }];
            
            const updatePayload = {};
            updatePayload[`player${playerNumber}History`] = newHistory;
            
            if (oks === 4) {
                updatePayload.gameState = `p${playerNumber}won`;
            } else {
                updatePayload.currentPlayer = opponentNumber;
                updatePayload.gameState = `p${opponentNumber}turn`;
            }
            
            await updateDoc(gameRef, updatePayload);
        }

        function listenToGame(id) {
            if (gameUnsubscribe) gameUnsubscribe();
            gameUnsubscribe = onSnapshot(doc(db, `artifacts/${appId}/public/data/games`, id), (doc) => {
                renderOnline(doc.data());
            });
        }
        
        function resetToLobby() {
            if (gameUnsubscribe) gameUnsubscribe();
            if (singlePlayerState.timerId) clearInterval(singlePlayerState.timerId);
            
            gameId = null;
            offlineState = {};
            singlePlayerState = {};
            mySecretCode = null;
            if(auth.currentUser) userId = auth.currentUser.uid;
            
            winnerModal.classList.add('hidden');
            opponentLeftModal.classList.add('hidden');
            exitGameBtn.classList.add('hidden');
            turnIndicator.textContent = '';
            document.getElementById('game-boards-container').innerHTML = '';
            document.getElementById('winner-message').style.color = 'var(--ok-color)'; // Reset color
            showSection('main-menu-section');
        }

        async function handleExitGame() {
            if (gameId) { // Online game
                const gameRef = doc(db, `artifacts/${appId}/public/data/games`, gameId);
                try {
                    const gameSnap = await getDoc(gameRef);
                    if (gameSnap.exists()) {
                        const gameData = gameSnap.data();
                        const playerNumber = gameData.player1Id === userId ? 1 : 2;
                        if (gameData.gameState.includes('turn') || gameData.gameState === 'setup' || gameData.gameState === 'waiting') {
                            await updateDoc(gameRef, { gameState: `p${playerNumber}left` });
                        }
                    }
                } catch (e) {
                    console.error("Error updating game state on exit:", e);
                }
            }
            resetToLobby();
        }

        // --- Event Listeners ---
        document.getElementById('lang-en-btn').addEventListener('click', () => {
            setLanguage('en');
            showSection('main-menu-section');
        });
        document.getElementById('lang-es-btn').addEventListener('click', () => {
            setLanguage('es');
            showSection('main-menu-section');
        });

        document.getElementById('show-offline-menu-btn').addEventListener('click', () => showSection('offline-lobby-section'));
        document.getElementById('show-online-menu-btn').addEventListener('click', () => showSection('online-lobby-section'));
        document.querySelectorAll('.back-to-main-menu-btn').forEach(btn => {
            btn.addEventListener('click', () => showSection('main-menu-section'));
        });

        document.getElementById('single-player-btn').addEventListener('click', () => {
            showSection('single-player-setup-section');
            exitGameBtn.classList.remove('hidden');
        });
        document.getElementById('offline-game-btn').addEventListener('click', startOfflineSetup);
        document.getElementById('start-offline-game-btn').addEventListener('click', startOfflineGame);
        document.getElementById('create-game-btn').addEventListener('click', createOnlineGame);
        document.getElementById('join-game-btn').addEventListener('click', joinOnlineGame);
        document.getElementById('submit-code-btn').addEventListener('click', submitOnlineCode);
        document.getElementById('play-again-btn').addEventListener('click', resetToLobby);
        document.getElementById('opponent-left-ok-btn').addEventListener('click', resetToLobby);
        document.getElementById('instructions-btn').addEventListener('click', () => instructionsModal.classList.remove('hidden'));
        document.getElementById('close-instructions-btn').addEventListener('click', () => instructionsModal.classList.add('hidden'));
        exitGameBtn.addEventListener('click', handleExitGame);
        document.getElementById('back-to-lang-btn').addEventListener('click', () => showSection('language-section'));
        document.getElementById('copy-id-btn').addEventListener('click', () => {
            const textToCopy = document.getElementById('game-id-display').textContent;
            const textArea = document.createElement('textarea');
            textArea.value = textToCopy;
            textArea.style.position = 'fixed';
            textArea.style.top = '-9999px';
            document.body.appendChild(textArea);
            textArea.select();
            try {
                document.execCommand('copy');
                showToast('idCopied');
            } catch (err) {
                showToast('copyFailed');
            }
            document.body.removeChild(textArea);
        });

        // --- Auth ---
        async function initializeAuth() {
            try {
                const token = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                if (token) {
                    await signInWithCustomToken(auth, token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Firebase Auth Error:", error);
            }
        }

        onAuthStateChanged(auth, user => {
            if (user) {
                userId = user.uid;
                showSection('language-section');
            }
        });
        
        initializeAuth();

    </script>
</body>
</html>
